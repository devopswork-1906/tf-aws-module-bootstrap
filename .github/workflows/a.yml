name: AWS Account Bootstrap

on:
  workflow_dispatch:
    inputs:
      tower:
        description: "Select workload tower"
        required: true
        type: choice
        options: [tu, int, cust, sec, coll, comm, fin]

      environment:
        description: "Target environment (drives env vars, approvals, role)"
        required: true
        type: choice
        options: [dev, tst, ppe, prd]

      region:
        description: "AWS Region"
        required: true
        default: "eu-west-1"

env:
  TF_WORKING_DIR: bootstrap

permissions:
  contents: read
  id-token: write

concurrency:
  group: bootstrap-${{ inputs.tower }}-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  aws_account_bootstrap:
    name: AWS Account Bootstrap - ${{ inputs.tower }} / ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Print Run Context
      # --------------------------------------------------
      - name: Print run context
        env:
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          TRIGGERING_ACTOR: ${{ github.event.sender.login || 'N/A' }}
          ACTION_TYPE: "bootstrap"
        run: |
          {
            echo "## AWS Account Bootstrap – Run Context"
            echo ""
            echo "| Key | Value |"
            echo "|-----|-------|"
            echo "| Tower | ${{ inputs.tower }} |"
            echo "| Environment | ${{ inputs.environment }} |"
            echo "| Region | ${{ inputs.region }} |"
            echo "| Repository | ${REPOSITORY} |"
            echo "| Run | ${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID} (#${RUN_NUMBER}) |"
            echo "| Trigger | ${EVENT_NAME} |"
            echo "| Actor | ${ACTOR} (triggering: ${TRIGGERING_ACTOR}) |"
            echo "| Action | ${ACTION_TYPE} |"
            echo "| Git Ref | ${{ github.ref }} |"
            echo "| Run ID | ${RUN_ID} |"
          } >> "$GITHUB_STEP_SUMMARY"

      # --------------------------------------------------
      # Fetch AWS Account ID (Python – portable & safe)
      # --------------------------------------------------
      - name: Fetch AWS Account ID
        id: fetch_aws_account_id
        shell: bash
        run: |
          ACCOUNT_ID=$(python3 - <<'EOF'
import json
import sys

tower = "${{ inputs.tower }}"
environment = "${{ inputs.environment }}"

with open("mappings/aws-accounts.json") as f:
    data = json.load(f)

account_id = data.get(tower, {}).get(environment, {}).get("account_id")

if not account_id:
    sys.exit("ERROR: No AWS account mapping found")

print(account_id)
EOF
)
          echo "account_id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"
          echo "| AWS Account ID | $ACCOUNT_ID |" >> "$GITHUB_STEP_SUMMARY"

      # --------------------------------------------------
      # Authenticate to AWS (OIDC two-hop)
      # --------------------------------------------------
      - name: Authenticate to AWS
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-oidc-auth@main
        with:
          target_account_id: ${{ steps.fetch_aws_account_id.outputs.account_id }}
          tower: ${{ inputs.tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      # --------------------------------------------------
      # Bootstrap AWS Account (Terraform)
      # --------------------------------------------------
      - name: Bootstrap AWS Account
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-account-bootstrap@main
        with:
          tower: ${{ inputs.tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}
          aws_account_id: ${{ steps.fetch_aws_account_id.outputs.account_id }}
          working_directory: ${{ env.TF_WORKING_DIR }}

      # --------------------------------------------------
      # Completion Summary
      # --------------------------------------------------
      - name: Print completion message
        run: |
          {
            echo ""
            echo "## ✅ AWS Account Bootstrap Completed"
            echo ""
            echo "- Tower: **${{ inputs.tower }}**"
            echo "- Environment: **${{ inputs.environment }}**"
            echo "- Region: **${{ inputs.region }}**"
            echo "- AWS Account ID: **${{ steps.fetch_aws_account_id.outputs.account_id }}**"
          } >> "$GITHUB_STEP_SUMMARY"