name: AWS Account Bootstrap

on:
  workflow_dispatch:
    inputs:
      workload_tower:
        description: Workload tower (tu, int, cust, sec, coll, comm, fin)
        required: true
        type: choice
        options: [tu, int, cust, sec, coll, comm, fin]
      environment:
        description: Target environment (drives GH environment for approvals, oidc iam role etc.)
        required: true
        type: choice
        options: [dev, tst, ppe, prd]
      CostCentre:
        description: Cost Centre tag value to apply to resources created in this account
        required: true
      region:
        description: AWS region to deploy the resources
        required: true
        default: eu-west-1
        type: string

permissions:
  contents: read
  id-token: write

# Bootstrap is a ONE-TIME operation per account
concurrency:
  group: bootstrap-${{ inputs.workload_tower }}-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  bootstrap-plan:
    name: Bootstrap plan for ${{ inputs.workload_tower }}-${{ inputs.environment }} AWS Account
    runs-on: ubuntu-latest
    outputs:
      account_id: ${{ steps.get_aws_account.outputs.account_id }}
      backend_bucket: ${{ steps.bucket.outputs.bucket }}
    env:
      WORKDIR : "."
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Generate GitHub App token
        id: app-token
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/github-app-token@v1
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Print run context
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/print-run-context@v1
        with:
          title: AWS Account Bootstrap for ${{ inputs.workload_tower }}-${{ inputs.environment }}
          workload_tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}
      
      # Resolve target AWS account
      - name: Get AWS Account for workload tower ${{ inputs.workload_tower }} and environment ${{ inputs.environment }}
        id: get_aws_account
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/get-aws-account-id@v1
        with:
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}

      # Authenticate using OIDC
      - name: Authenticate to ${{ inputs.workload_tower }}-${{ inputs.environment }} AWS Account
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-oidc-auth@v1
        with:
          target_account_id: ${{ steps.get_aws_account.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Compute bootstrap bucket
        id: bucket
        run: |
          echo "bucket=${{ inputs.workload_tower }}-${{ inputs.environment }}-terraform-${{ steps.get_aws_account.outputs.account_id }}-backend" >> "$GITHUB_OUTPUT"

      - name: Ensure Terraform backend bucket
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-backend-bootstrap@v1
        with:
          bucket_name: ${{ steps.bucket.outputs.bucket }}
          region: ${{ inputs.region }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          cost_centre: ${{ inputs.CostCentre }}
      
      - name: Generate GitHub metadata tfvars
        working-directory: "${{ env.WORKDIR }}"
        run: |
          set -euo pipefail
          cat <<EOF > "${{ env.WORKDIR }}/terraform.auto.tfvars.json"
          {
            "tower": "${{ inputs.workload_tower }}",
            "environment": "${{ inputs.environment }}",
            "region": "${{ inputs.region }}",
            "CostCentre": "${{ inputs.CostCentre }}",
            "github_tags": {
              "github_repository": "${{ github.repository }}",
              "source_url": "${{ github.server_url }}/${{ github.repository }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "actor": "${{ github.actor }}",
              "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }
          }
          EOF
          echo "Generated terraform.auto.tfvars.json with the following content:"
          cat terraform.auto.tfvars.json

      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup-temp@v1
        with:
          working_directory: "${{ env.WORKDIR }}"
          backend_config_file: "${{ env.WORKDIR }}/${{ inputs.environment }}.tfbackend"
          terraform_version: "1.10.0"
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Terraform plan
        id: tf_plan
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-plan@v1
        with:
          working_directory: "${{ env.WORKDIR }}"
          environment: ${{ inputs.environment }}

  approvals:
    name: Wait for Approval before proceeding for terraform apply job
    runs-on: ubuntu-latest
    needs: bootstrap-plan
    environment: ${{ fromJSON('{"prd":"production","ppe":"pre-production","tst":"test","dev":"development"}')[inputs.environment] }}
    steps:
      - name: Awaiting approval to proceed
        run: echo "The job is awaiting approval to proceed."
  
  bootstrap-apply:
    name: Bootstrap apply for ${{ inputs.workload_tower }}-${{ inputs.environment }} AWS Account
    runs-on: ubuntu-latest
    needs: [bootstrap-plan, approvals]
    env:
      WORKDIR : "."
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate GitHub App token
        id: app-token
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/github-app-token@v1
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      # Authenticate using OIDC
      - name: Authenticate to ${{ inputs.workload_tower }}-${{ inputs.environment }} AWS Account
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-oidc-auth@v1
        with:
          target_account_id: ${{ needs.bootstrap-plan.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Generate terraform backend config
        run: |
          cat <<EOF > ${{ env.WORKDIR }}/${{ inputs.environment }}.tfbackend
          bucket = "${{ needs.bootstrap-plan.outputs.backend_bucket }}"
          key    = "bootstrap/terraform.tfstate"
          region = "${{ inputs.region }}"
          encrypt = true
          use_lockfile = true
          EOF
          cat ${{ env.WORKDIR }}/${{ inputs.environment }}.tfbackend
      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup-temp@v1
        with:
          working_directory: "${{ env.WORKDIR }}"
          backend_config_file: "${{ env.WORKDIR }}/${{ inputs.environment }}.tfbackend"
          terraform_version: "1.10.0"
          github_token: ${{ steps.app-token.outputs.token }}
      - name: Generate GitHub metadata tfvars
        working-directory: "${{ env.WORKDIR }}"
        run: |
          set -euo pipefail
          cat <<EOF > "${{ env.WORKDIR }}/terraform.auto.tfvars.json"
          {
            "tower": "${{ inputs.workload_tower }}",
            "environment": "${{ inputs.environment }}",
            "region": "${{ inputs.region }}",
            "CostCentre": "${{ inputs.CostCentre }}",
            "github_tags": {
              "github_repository": "${{ github.repository }}",
              "source_url": "${{ github.server_url }}/${{ github.repository }}",
              "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "actor": "${{ github.actor }}",
              "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }
          }
          EOF
          echo "Generated terraform.auto.tfvars.json with the following content:"
          cat terraform.auto.tfvars.json
      - name: Terraform Plan
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-plan@v1
        with:
          working_directory: "${{ env.WORKDIR }}"
          environment: "${{ inputs.environment }}"
      - name: Apply Terraform plan
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-apply@v1
        with:
          working_directory: "${{ env.WORKDIR }}"
          plan_file: plan-${{ inputs.environment }}.tfplan